<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stir Trek 2026 Schedule</title>
<style>
  :root {
    --app-dev: #3b82f6;
    --arch: #8b5cf6;
    --ai-ml: #ec4899;
    --pro-growth: #f59e0b;
    --sw-quality: #10b981;
    --security: #ef4444;
    --product-ux: #06b6d4;
    --data-eng: #f97316;
    --other: #6b7280;
    --breakfast: #fef3c7;
    --lunch: #fef3c7;
    --pending: #f3f4f6;
    --movie: #1e1b4b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f8fafc;
    color: #1e293b;
    padding: 24px;
  }

  h1 { text-align: center; font-size: 2rem; margin-bottom: 4px; color: #0f172a; }
  .subtitle { text-align: center; color: #64748b; margin-bottom: 16px; font-size: 0.95rem; }

  /* ── Version bar ── */
  .version-bar {
    display: flex; justify-content: center; align-items: center;
    gap: 12px; margin-bottom: 8px; flex-wrap: wrap;
  }
  .version-bar label { font-weight: 700; font-size: 0.85rem; color: #334155; }
  .version-select {
    padding: 6px 12px; border: 2px solid #e2e8f0; border-radius: 8px;
    font-size: 0.85rem; font-weight: 600; background: white; cursor: pointer; min-width: 280px;
  }
  .version-select:focus { outline: none; border-color: #3b82f6; }
  .version-description {
    text-align: center; color: #94a3b8; font-size: 0.8rem;
    margin-bottom: 12px; font-style: italic; min-height: 1.2em;
  }

  /* ── Changes bar ── */
  .changes-bar {
    display: none; justify-content: center; align-items: center;
    gap: 12px; margin-bottom: 16px; padding: 12px 20px;
    background: #fffbeb; border: 2px solid #f59e0b; border-radius: 10px;
    flex-wrap: wrap;
  }
  .changes-bar.visible { display: flex; }
  .changes-count { font-weight: 700; font-size: 0.9rem; color: #92400e; }
  .changes-bar button {
    padding: 6px 14px; border-radius: 6px; font-size: 0.8rem;
    font-weight: 600; cursor: pointer; border: none; transition: all 0.15s;
  }
  .btn-undo { background: #e2e8f0; color: #334155; }
  .btn-undo:hover { background: #cbd5e1; }
  .btn-reset { background: #fecaca; color: #991b1b; }
  .btn-reset:hover { background: #fca5a5; }
  .btn-propose { background: #059669; color: white; padding: 8px 20px !important; font-size: 0.85rem !important; }
  .btn-propose:hover { background: #047857; }
  .btn-propose:disabled { background: #9ca3af; cursor: not-allowed; }

  /* ── Legend ── */
  .legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 24px; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; font-weight: 500; }
  .legend-dot { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }

  /* ── Grid ── */
  .schedule-grid {
    display: grid; grid-template-columns: 160px repeat(8, 1fr); gap: 2px;
    background: #e2e8f0; border-radius: 12px; overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
  }
  .cell { padding: 10px; background: white; min-height: 60px; display: flex; flex-direction: column; justify-content: center; }
  .header-cell { background: #0f172a; color: white; font-weight: 700; font-size: 0.85rem; text-align: center; padding: 12px 6px; }
  .header-room-name { display: block; font-size: 0.85rem; }
  .header-capacity { display: block; font-size: 0.95rem; font-weight: 800; margin-top: 2px; color: #f59e0b; }
  .header-theaters { display: block; font-size: 0.6rem; font-weight: 400; color: #94a3b8; margin-top: 3px; line-height: 1.3; }

  .time-cell {
    background: #f1f5f9; font-weight: 700; font-size: 0.82rem; color: #334155;
    display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; line-height: 1.4;
  }
  .time-cell .slot-label { font-size: 0.7rem; color: #94a3b8; margin-top: 4px; font-weight: 500; }

  .session-cell {
    border-left: 4px solid transparent; cursor: grab; transition: transform 0.1s ease, box-shadow 0.1s ease; position: relative;
  }
  .session-cell:hover { transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10; }
  .session-title { font-weight: 600; font-size: 0.78rem; line-height: 1.3; margin-bottom: 4px; }
  .session-speaker { font-size: 0.72rem; color: #64748b; font-weight: 500; }
  .session-track {
    font-size: 0.65rem; margin-top: 4px; padding: 2px 6px; border-radius: 3px;
    display: inline-block; font-weight: 600; color: white; max-width: fit-content;
  }
  .attendance-badge {
    font-size: 0.6rem; margin-top: 3px; padding: 1px 5px; border-radius: 3px;
    display: inline-block; font-weight: 600; background: #fef3c7; color: #92400e; max-width: fit-content;
  }

  .break-cell { text-align: center; font-weight: 700; font-size: 0.9rem; letter-spacing: 0.5px; }
  .breakfast-cell { background: var(--breakfast); color: #92400e; }
  .lunch-cell { background: var(--lunch); color: #92400e; }
  .pending-cell { background: var(--pending); color: #9ca3af; font-style: italic; }
  .movie-cell { background: var(--movie); color: #c4b5fd; }

  .track-app-dev { border-left-color: var(--app-dev); }
  .track-arch { border-left-color: var(--arch); }
  .track-ai-ml { border-left-color: var(--ai-ml); }
  .track-pro-growth { border-left-color: var(--pro-growth); }
  .track-sw-quality { border-left-color: var(--sw-quality); }
  .track-security { border-left-color: var(--security); }
  .track-product-ux { border-left-color: var(--product-ux); }
  .track-data-eng { border-left-color: var(--data-eng); }
  .track-other { border-left-color: var(--other); }

  .badge-app-dev { background: var(--app-dev); }
  .badge-arch { background: var(--arch); }
  .badge-ai-ml { background: var(--ai-ml); }
  .badge-pro-growth { background: var(--pro-growth); }
  .badge-sw-quality { background: var(--sw-quality); }
  .badge-security { background: var(--security); }
  .badge-product-ux { background: var(--product-ux); }
  .badge-data-eng { background: var(--data-eng); }
  .badge-other { background: var(--other); }

  /* ── Stats ── */
  .stats { margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .stat-card { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .stat-card h3 { font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
  .stat-card .value { font-size: 1.6rem; font-weight: 800; color: #0f172a; }
  .stat-card .detail { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }

  /* ── Filter bar ── */
  .filter-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .filter-btn {
    padding: 6px 14px; border: 2px solid #e2e8f0; border-radius: 20px;
    background: white; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.15s ease;
  }
  .filter-btn:hover { border-color: #94a3b8; }
  .filter-btn.active { border-color: #0f172a; background: #0f172a; color: white; }

  .capacity-bar { width: 100%; height: 3px; background: #e2e8f0; border-radius: 2px; margin-top: 4px; overflow: hidden; }
  .capacity-fill { height: 100%; border-radius: 2px; background: #f59e0b; }

  /* ── Diff highlights ── */
  .diff-highlight { outline: 3px solid #f59e0b; outline-offset: -3px; background: #fffbeb !important; }

  /* ── Drag & Drop ── */
  .session-cell.dragging { opacity: 0.4; transform: scale(0.95); }
  .session-cell.drag-over {
    outline: 3px dashed #3b82f6; outline-offset: -3px;
    background: #eff6ff !important;
  }
  .session-cell.swap-highlight {
    animation: swapPulse 0.6s ease;
  }
  @keyframes swapPulse {
    0% { outline: 3px solid #059669; outline-offset: -3px; }
    100% { outline: 3px solid transparent; outline-offset: -3px; }
  }

  /* ── Notification ── */
  .notification {
    position: fixed; top: 20px; right: 20px; z-index: 2000;
    padding: 14px 20px; border-radius: 10px; font-size: 0.85rem; font-weight: 600;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-width: 500px;
    animation: slideIn 0.3s ease;
  }
  .notification a { color: inherit; text-decoration: underline; }
  .notification.success { background: #ecfdf5; color: #065f46; border: 2px solid #059669; }
  .notification.error { background: #fef2f2; color: #991b1b; border: 2px solid #ef4444; }
  .notification.info { background: #eff6ff; color: #1e40af; border: 2px solid #3b82f6; }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* ── Swap log ── */
  .swap-log { margin-top: 24px; }
  .swap-log h3 { font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 10px; }
  .swap-entry {
    background: white; border-radius: 8px; padding: 10px 14px; margin-bottom: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-size: 0.8rem; display: flex; align-items: center; gap: 10px;
  }
  .swap-entry .swap-arrow { font-size: 1.1rem; color: #3b82f6; }
  .swap-entry .swap-detail { color: #475569; }
  .swap-entry .swap-detail strong { color: #0f172a; }

  @media (max-width: 1200px) { .schedule-grid { font-size: 0.85em; } }
  @media print {
    body { padding: 0; background: white; }
    .filter-bar, .version-bar, .version-description, .changes-bar, .swap-log { display: none !important; }
    .session-cell { cursor: default; }
    .session-cell:hover { transform: none; box-shadow: none; }
  }
</style>
</head>
<body>

<h1>Stir Trek 2026</h1>
<p class="subtitle">May 2, 2026 &mdash; 56 Sessions &bull; 9 Tracks &bull; 7 Time Slots &bull; 8 Rooms &bull; 2,194 Total Seats</p>

<div class="version-bar">
  <label for="version-picker">Schedule Version:</label>
  <select id="version-picker" class="version-select"></select>
  <label style="margin-left:16px"><input type="checkbox" id="diff-toggle"> Highlight changes from prev</label>
</div>
<div class="version-description" id="version-desc"></div>

<div class="changes-bar" id="changes-bar">
  <span class="changes-count" id="changes-count">0 changes</span>
  <button class="btn-undo" id="undo-btn">Undo Last</button>
  <button class="btn-reset" id="reset-btn">Reset All</button>
  <button class="btn-propose" id="propose-btn">Propose Changes</button>
</div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:var(--app-dev)"></div>Application Development</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--arch)"></div>Architecture</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--ai-ml)"></div>AI &amp; ML</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--pro-growth)"></div>Professional Growth</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--sw-quality)"></div>Software Quality</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--security)"></div>Security</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--product-ux)"></div>Product &amp; UX</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--data-eng)"></div>Data Engineering</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--other)"></div>Other</div>
</div>

<div class="filter-bar">
  <button class="filter-btn active" data-track="all">All Tracks</button>
  <button class="filter-btn" data-track="Application Development">App Dev</button>
  <button class="filter-btn" data-track="Architecture & Platform Engineering">Architecture</button>
  <button class="filter-btn" data-track="Artificial Intelligence & Machine Learning">AI &amp; ML</button>
  <button class="filter-btn" data-track="Professional Growth & Leadership">Prof Growth</button>
  <button class="filter-btn" data-track="Software Quality & Delivery">SW Quality</button>
  <button class="filter-btn" data-track="Security & Privacy Engineering">Security</button>
  <button class="filter-btn" data-track="Product Design & User Experience">Product UX</button>
  <button class="filter-btn" data-track="Data Engineering & Analytics">Data Eng</button>
  <button class="filter-btn" data-track="Other">Other</button>
</div>

<div class="schedule-grid" id="grid"></div>

<div class="swap-log" id="swap-log" style="display:none">
  <h3>Pending Swaps</h3>
  <div id="swap-entries"></div>
</div>

<div class="stats" id="stats"></div>

<script>
// ─── Injected Data (replaced by schedule_builder.py) ───
const rooms = __ROOMS_DATA__;
const sessions = __SESSIONS_DATA__;
const versions = __VERSIONS_DATA__;
const attendance2025 = __ATTENDANCE_DATA__;

// ─── Constants ───
const maxCapacity = Math.max(...rooms.map(r => r.capacity));
const slotTimes = [
  { time: "08:30 - 09:15", label: "Slot 1" },
  { time: "09:30 - 10:15", label: "Slot 2" },
  { time: "10:30 - 11:15", label: "Slot 3" },
  { time: "11:30 - 12:15", label: "Slot 4" },
  { time: "02:00 - 02:45", label: "Slot 5" },
  { time: "03:00 - 03:45", label: "Slot 6" },
  { time: "04:00 - 04:45", label: "Slot 7" }
];
const slotLabels = {
  slot_1: "Slot 1 (08:30)", slot_2: "Slot 2 (09:30)", slot_3: "Slot 3 (10:30)",
  slot_4: "Slot 4 (11:30)", slot_5: "Slot 5 (02:00)", slot_6: "Slot 6 (03:00)",
  slot_7: "Slot 7 (04:00)"
};

// ─── State ───
let currentVersionIdx = versions.length - 1;
let currentSchedule = JSON.parse(JSON.stringify(versions[currentVersionIdx].schedule));
let originalSchedule = JSON.parse(JSON.stringify(currentSchedule));
let activeFilter = "all";
let showDiff = false;
let swaps = [];
let dragSource = null;

// ─── Helpers ───
function trackClass(track) {
  const map = {
    "Application Development": "app-dev",
    "Architecture & Platform Engineering": "arch",
    "Artificial Intelligence & Machine Learning": "ai-ml",
    "Professional Growth & Leadership": "pro-growth",
    "Software Quality & Delivery": "sw-quality",
    "Security & Privacy Engineering": "security",
    "Product Design & User Experience": "product-ux",
    "Data Engineering & Analytics": "data-eng",
    "Other": "other"
  };
  return map[track] || "other";
}

function shortTrack(track) {
  const map = {
    "Application Development": "App Dev",
    "Architecture & Platform Engineering": "Architecture",
    "Artificial Intelligence & Machine Learning": "AI & ML",
    "Professional Growth & Leadership": "Prof Growth",
    "Software Quality & Delivery": "SW Quality",
    "Security & Privacy Engineering": "Security",
    "Product Design & User Experience": "Product UX",
    "Data Engineering & Analytics": "Data Eng",
    "Other": "Other"
  };
  return map[track] || track;
}

function roomLabel(pos) {
  return rooms[pos] ? `${rooms[pos].alias} (${rooms[pos].capacity})` : `Position ${pos}`;
}

function escHtml(str) {
  const d = document.createElement("div");
  d.textContent = str;
  return d.innerHTML;
}

// ─── Validation ───
function validateSchedule(schedule) {
  const errors = [];
  for (const [slotKey, slotIds] of Object.entries(schedule)) {
    const speakersSeen = [];
    for (const sid of slotIds) {
      const s = sessions[sid];
      if (!s) { errors.push(`Unknown session ${sid} in ${slotKey}`); continue; }
      if (speakersSeen.includes(s.speakers)) {
        errors.push(`${slotLabels[slotKey] || slotKey}: "${s.speakers}" appears twice`);
      }
      speakersSeen.push(s.speakers);
    }
  }
  return errors;
}

// ─── Diff ───
function getDiffSet() {
  if (!showDiff || currentVersionIdx <= 0) return new Set();
  const prev = versions[currentVersionIdx - 1].schedule;
  const diffs = new Set();
  for (const slot of Object.keys(currentSchedule).sort()) {
    const curIds = currentSchedule[slot] || [];
    const prevIds = prev[slot] || [];
    for (let i = 0; i < 8; i++) {
      if (curIds[i] !== prevIds[i]) diffs.add(`${slot}:${i}`);
    }
  }
  return diffs;
}

// ─── Render ───
function render() {
  const schedule = currentSchedule;
  const diffs = getDiffSet();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  document.getElementById("version-desc").textContent =
    versions[currentVersionIdx].description || "";

  // Header row
  const th = document.createElement("div");
  th.className = "cell header-cell";
  th.textContent = "Time";
  grid.appendChild(th);

  for (const room of rooms) {
    const h = document.createElement("div");
    h.className = "cell header-cell";
    const pct = (room.capacity / maxCapacity * 100).toFixed(0);
    h.innerHTML = `
      <span class="header-room-name">${escHtml(room.alias)}</span>
      <span class="header-capacity">${room.capacity} seats</span>
      <span class="header-theaters">Live: ${room.live}<br>Simulcast: ${room.simulcast}</span>
      <div class="capacity-bar"><div class="capacity-fill" style="width:${pct}%"></div></div>
    `;
    grid.appendChild(h);
  }

  addBreakRow("07:30 - 08:30", "Breakfast", "breakfast-cell");
  const slotKeys = Object.keys(schedule).sort();
  for (let i = 0; i < 4; i++) addSessionRow(slotTimes[i], schedule[slotKeys[i]], slotKeys[i], diffs);
  addBreakRow("12:15 - 01:00", "Lunch", "lunch-cell");
  addBreakRow("01:00 - 01:45", "Pending", "pending-cell");
  for (let i = 4; i < 7; i++) addSessionRow(slotTimes[i], schedule[slotKeys[i]], slotKeys[i], diffs);
  addBreakRow("05:00 - 06:00", "Movie Trailers", "movie-cell");

  renderStats(schedule);
  renderSwapLog();
}

function addBreakRow(time, label, cls) {
  const grid = document.getElementById("grid");
  const tc = document.createElement("div");
  tc.className = "cell time-cell";
  tc.innerHTML = `<span>${time}</span>`;
  grid.appendChild(tc);
  for (let i = 0; i < 8; i++) {
    const c = document.createElement("div");
    c.className = `cell break-cell ${cls}`;
    c.textContent = label;
    grid.appendChild(c);
  }
}

function addSessionRow(slotInfo, sessionIds, slotKey, diffs) {
  const grid = document.getElementById("grid");
  const tc = document.createElement("div");
  tc.className = "cell time-cell";
  tc.innerHTML = `<span>${slotInfo.time}</span><span class="slot-label">${slotInfo.label}</span>`;
  grid.appendChild(tc);

  sessionIds.forEach((sid, idx) => {
    const s = sessions[sid];
    const tc2 = trackClass(s.track);
    const dimmed = activeFilter !== "all" && s.track !== activeFilter;
    const isDiff = diffs.has(`${slotKey}:${idx}`);
    const c = document.createElement("div");
    c.className = `cell session-cell track-${tc2}${isDiff ? " diff-highlight" : ""}`;
    if (dimmed) c.style.opacity = "0.15";

    const att = attendance2025[s.speakers];
    const attHtml = att ? `<span class="attendance-badge">2025: ${att} attendees</span>` : "";
    c.innerHTML = `
      <div class="session-title">${escHtml(s.title)}</div>
      <div class="session-speaker">${escHtml(s.speakers)}</div>
      <span class="session-track badge-${tc2}">${shortTrack(s.track)}</span>
      ${attHtml}
    `;

    // Drag & drop attributes
    c.draggable = true;
    c.dataset.slot = slotKey;
    c.dataset.pos = idx;
    c.dataset.sid = sid;

    c.addEventListener("dragstart", onDragStart);
    c.addEventListener("dragover", onDragOver);
    c.addEventListener("dragenter", onDragEnter);
    c.addEventListener("dragleave", onDragLeave);
    c.addEventListener("drop", onDrop);
    c.addEventListener("dragend", onDragEnd);

    grid.appendChild(c);
  });
}

function renderStats(schedule) {
  const stats = document.getElementById("stats");
  stats.innerHTML = "";
  const trackCounts = {};
  const slotKeys = Object.keys(schedule).sort();
  let doublings = 0;
  for (const sk of slotKeys) {
    const tracksInSlot = {};
    for (const sid of schedule[sk]) {
      const t = sessions[sid].track;
      tracksInSlot[t] = (tracksInSlot[t] || 0) + 1;
      trackCounts[t] = (trackCounts[t] || 0) + 1;
    }
    for (const c of Object.values(tracksInSlot)) {
      if (c > 1) doublings += c - 1;
    }
  }
  const totalSeats = rooms.reduce((a, r) => a + r.capacity, 0);
  const cards = [
    { label: "Total Sessions", value: "56", detail: "7 slots \u00d7 8 rooms" },
    { label: "Total Capacity", value: totalSeats.toLocaleString(), detail: "Per time slot across all rooms" },
    { label: "Tracks", value: Object.keys(trackCounts).length, detail: "Across all sessions" },
    { label: "Track Doublings", value: doublings, detail: "Theoretical min: 7" },
    { label: "Dual Speakers", value: "7", detail: "All separated into different slots" },
    { label: "Largest Room", value: "388", detail: "Room 1: Theater 14 + simulcast" }
  ];
  for (const card of cards) {
    const el = document.createElement("div");
    el.className = "stat-card";
    el.innerHTML = `<h3>${card.label}</h3><div class="value">${card.value}</div><div class="detail">${card.detail}</div>`;
    stats.appendChild(el);
  }
}

function renderSwapLog() {
  const log = document.getElementById("swap-log");
  const entries = document.getElementById("swap-entries");
  if (swaps.length === 0) {
    log.style.display = "none";
    return;
  }
  log.style.display = "block";
  entries.innerHTML = "";
  swaps.forEach((sw, i) => {
    const el = document.createElement("div");
    el.className = "swap-entry";
    el.innerHTML = `
      <span style="color:#94a3b8;font-size:0.7rem;min-width:20px">#${i+1}</span>
      <span class="swap-detail">
        <strong>${escHtml(sessions[sw.aSid].title)}</strong>
        (${slotLabels[sw.aSlot]}, ${roomLabel(sw.aPos)})
      </span>
      <span class="swap-arrow">\u21c4</span>
      <span class="swap-detail">
        <strong>${escHtml(sessions[sw.bSid].title)}</strong>
        (${slotLabels[sw.bSlot]}, ${roomLabel(sw.bPos)})
      </span>
    `;
    entries.appendChild(el);
  });
}

// ─── Changes bar ───
function updateChangesBar() {
  const bar = document.getElementById("changes-bar");
  const count = document.getElementById("changes-count");
  if (swaps.length > 0) {
    bar.classList.add("visible");
    count.textContent = `${swaps.length} swap${swaps.length === 1 ? "" : "s"} pending`;
  } else {
    bar.classList.remove("visible");
  }
}

// ─── Drag & Drop ───
function onDragStart(e) {
  dragSource = {
    slot: this.dataset.slot,
    pos: parseInt(this.dataset.pos),
    sid: this.dataset.sid,
    el: this
  };
  e.dataTransfer.effectAllowed = "move";
  e.dataTransfer.setData("text/plain", this.dataset.sid);
  requestAnimationFrame(() => this.classList.add("dragging"));
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
}

function onDragEnter(e) {
  e.preventDefault();
  if (this !== dragSource?.el) this.classList.add("drag-over");
}

function onDragLeave() {
  this.classList.remove("drag-over");
}

function onDragEnd() {
  this.classList.remove("dragging");
  document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over"));
  dragSource = null;
}

function onDrop(e) {
  e.preventDefault();
  this.classList.remove("drag-over");
  if (!dragSource || dragSource.sid === this.dataset.sid) return;

  const target = {
    slot: this.dataset.slot,
    pos: parseInt(this.dataset.pos),
    sid: this.dataset.sid
  };

  // Perform swap in schedule
  currentSchedule[dragSource.slot][dragSource.pos] = target.sid;
  currentSchedule[target.slot][target.pos] = dragSource.sid;

  // Validate
  const errors = validateSchedule(currentSchedule);
  if (errors.length > 0) {
    // Revert
    currentSchedule[dragSource.slot][dragSource.pos] = dragSource.sid;
    currentSchedule[target.slot][target.pos] = target.sid;
    showNotification("Can't swap: " + errors.join("; "), "error");
    return;
  }

  // Record swap
  swaps.push({
    aSlot: dragSource.slot, aPos: dragSource.pos, aSid: dragSource.sid,
    bSlot: target.slot, bPos: target.pos, bSid: target.sid
  });

  updateChangesBar();
  render();
  showNotification(
    `Swapped "${sessions[dragSource.sid].title}" \u21c4 "${sessions[target.sid].title}"`,
    "info"
  );
}

// ─── Undo / Reset ───
document.getElementById("undo-btn").addEventListener("click", () => {
  if (swaps.length === 0) return;
  const last = swaps.pop();
  // Revert the swap
  currentSchedule[last.aSlot][last.aPos] = last.aSid;
  currentSchedule[last.bSlot][last.bPos] = last.bSid;
  updateChangesBar();
  render();
  showNotification("Undid last swap", "info");
});

document.getElementById("reset-btn").addEventListener("click", () => {
  if (swaps.length === 0) return;
  currentSchedule = JSON.parse(JSON.stringify(originalSchedule));
  swaps = [];
  updateChangesBar();
  render();
  showNotification("Reset all changes", "info");
});

// ─── GitHub Repo ───
const githubRepo = "__GITHUB_REPO__";

// ─── Propose Changes (GitHub Issue) ───
document.getElementById("propose-btn").addEventListener("click", () => {
  if (swaps.length === 0) return;

  const errors = validateSchedule(currentSchedule);
  if (errors.length > 0) {
    showNotification("Schedule has errors: " + errors.join("; "), "error");
    return;
  }

  const ver = versions[currentVersionIdx];
  let body = "<!-- SCHEDULE_SWAP -->\n";
  body += "## Schedule Swap Proposal\n\n";
  body += `**${swaps.length} swap${swaps.length === 1 ? "" : "s"}** proposed based on v${ver.version}: ${ver.label}.\n\n`;
  body += "### Changes\n\n";
  swaps.forEach((sw, i) => {
    const a = sessions[sw.aSid];
    const b = sessions[sw.bSid];
    body += `${i+1}. **${a.title}** (${a.speakers}) in ${slotLabels[sw.aSlot]}, ${roomLabel(sw.aPos)}`;
    body += ` \u21c4 **${b.title}** (${b.speakers}) in ${slotLabels[sw.bSlot]}, ${roomLabel(sw.bPos)}\n`;
  });
  body += "\n### Proposed Schedule\n\n";
  body += "```json\n";
  body += JSON.stringify(currentSchedule, null, 2);
  body += "\n```\n\n";
  body += "---\n*Proposed via the Stir Trek 2026 Schedule Builder*\n";

  const title = `Schedule swap: ${swaps.length} change${swaps.length === 1 ? "" : "s"} (v${ver.version})`;
  const url = `https://github.com/${githubRepo}/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;

  window.open(url, "_blank");
  showNotification("Opening GitHub to submit your proposal...", "info");
});

// ─── Notifications ───
let notifTimer = null;
function showNotification(msg, type, duration) {
  duration = duration || 3500;
  let el = document.getElementById("notification");
  if (!el) {
    el = document.createElement("div");
    el.id = "notification";
    document.body.appendChild(el);
  }
  el.className = `notification ${type}`;
  el.innerHTML = msg;
  el.style.display = "block";
  clearTimeout(notifTimer);
  notifTimer = setTimeout(() => { el.style.display = "none"; }, duration);
}

// ─── Version Picker ───
const picker = document.getElementById("version-picker");
versions.forEach((v, i) => {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = `v${v.version}: ${v.label} (${v.created.split("T")[0]})`;
  if (i === versions.length - 1) opt.selected = true;
  picker.appendChild(opt);
});

picker.addEventListener("change", () => {
  // Warn if unsaved changes
  if (swaps.length > 0 && !confirm("You have unsaved swaps. Switching versions will discard them. Continue?")) {
    picker.value = currentVersionIdx;
    return;
  }
  currentVersionIdx = parseInt(picker.value);
  currentSchedule = JSON.parse(JSON.stringify(versions[currentVersionIdx].schedule));
  originalSchedule = JSON.parse(JSON.stringify(currentSchedule));
  swaps = [];
  updateChangesBar();
  render();
});

document.getElementById("diff-toggle").addEventListener("change", (e) => {
  showDiff = e.target.checked;
  render();
});

// ─── Track Filter ───
document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    activeFilter = btn.dataset.track;
    render();
  });
});

// ─── Init ───
render();
</script>
</body>
</html>
